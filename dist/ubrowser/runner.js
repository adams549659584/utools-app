const{EventEmitter}=require("events"),emitter=new EventEmitter;function callRemoteFunction(e,t){return new Promise(((n,r)=>{emitter.once("return",(e=>{if(e.error)return r(new Error(e.error));n(e.data)})),process.send({method:e,args:t})}))}function waitTime(e){return new Promise((t=>{setTimeout(t,e)}))}function waitCall(e,t){return new Promise(((n,r)=>{t<250&&(t=300);const o=[e];let i,s;const a=()=>{callRemoteFunction("javascript",o).then((e=>{if(!0===e)return clearTimeout(s),void n();i=setTimeout(a,250)})).catch((e=>{clearTimeout(s),r(new Error("wait: "+e.message))}))};i=setTimeout(a,250),s=setTimeout((()=>{clearTimeout(i),r(new Error("wait: "+t+" ms timeout"))}),t)}))}function runWait(...e){return"number"==typeof e[0]?waitTime(e[0]):"string"==typeof e[0]?waitCall(e[0],e[1]):new Promise(((e,t)=>{t(new Error("wati: parameter error"))}))}function runWhen(e){return new Promise(((t,n)=>{callRemoteFunction("javascript",[e]).then((e=>{t(!0===e)})).catch((e=>{n(new Error("when: "+e.message))}))}))}function findWhenEnd(e){let t=0;for(const n of e)if("when"!==n.method){if("end"===n.method){if(0===t)return n;t--}}else t++}async function run(e){const t=[];for(let n=0;n<e.length;n++){const r=e[n];if(r&&"end"!==r.method)try{if("wait"===r.method){await runWait(...r.args);continue}if("when"===r.method){const t=findWhenEnd(e.slice(n+1));if(await runWhen(...r.args)){t&&(e[e.indexOf(t)]=null);continue}if(t){const r=e.indexOf(t);for(let t=n;t<=r;t++)e[t]=null;continue}const o=e.slice(n+1).find((e=>!e));if(o){const t=e.indexOf(o);for(let r=n;r<=t;r++)e[r]=null;continue}break}const o=await callRemoteFunction(r.method,r.args);void 0!==o&&t.push(o)}catch(e){return process.send({method:"end",args:[{data:t.length>0?t:void 0,error:e.message}]})}}process.send({method:"end",args:[{data:t.length>0?t:void 0}]})}process.on("message",(({method:e,args:t})=>{if("return"===e)return emitter.emit("return",t[0]);"run"===e&&run.apply(null,t)}));